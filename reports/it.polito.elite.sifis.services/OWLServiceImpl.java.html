<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OWLServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sifis</a> &gt; <a href="index.source.html" class="el_package">it.polito.elite.sifis.services</a> &gt; <span class="el_source">OWLServiceImpl.java</span></div><h1>OWLServiceImpl.java</h1><pre class="source lang-java linenums">package it.polito.elite.sifis.services;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingDeque;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.semanticweb.HermiT.Reasoner;
import org.semanticweb.owlapi.apibinding.OWLManager;
import org.semanticweb.owlapi.model.AddAxiom;
import org.semanticweb.owlapi.model.AddImport;
import org.semanticweb.owlapi.model.IRI;
import org.semanticweb.owlapi.model.OWLClass;
import org.semanticweb.owlapi.model.OWLClassAssertionAxiom;
import org.semanticweb.owlapi.model.OWLClassExpression;
import org.semanticweb.owlapi.model.OWLDataProperty;
import org.semanticweb.owlapi.model.OWLDataPropertyAssertionAxiom;
import org.semanticweb.owlapi.model.OWLImportsDeclaration;
import org.semanticweb.owlapi.model.OWLNamedIndividual;
import org.semanticweb.owlapi.model.OWLObjectProperty;
import org.semanticweb.owlapi.model.OWLObjectPropertyAssertionAxiom;
import org.semanticweb.owlapi.model.OWLOntology;
import org.semanticweb.owlapi.model.OWLOntologyCreationException;
import org.semanticweb.owlapi.model.OWLOntologyManager;
import org.semanticweb.owlapi.model.OWLOntologyStorageException;
import org.semanticweb.owlapi.reasoner.InferenceType;
import org.semanticweb.owlapi.reasoner.OWLReasoner;
import org.semanticweb.owlapi.search.EntitySearcher;
import org.semanticweb.owlapi.util.AutoIRIMapper;
import org.semanticweb.owlapi.util.DefaultPrefixManager;
import org.semanticweb.owlapi.util.OWLEntityRemover;
import org.springframework.beans.factory.annotation.Autowired;
import it.polito.elite.sifis.entities.db.Dbentity;
import it.polito.elite.sifis.entities.owl.Action;
import it.polito.elite.sifis.entities.owl.Command;
import it.polito.elite.sifis.entities.owl.Detail;
import it.polito.elite.sifis.entities.owl.IoTEntity;
import it.polito.elite.sifis.entities.owl.Location;
import it.polito.elite.sifis.entities.owl.Notification;
import it.polito.elite.sifis.entities.owl.Rule;
import it.polito.elite.sifis.entities.owl.Service;
import it.polito.elite.sifis.entities.owl.Technology;
import it.polito.elite.sifis.entities.owl.Trigger;
import it.polito.elite.sifis.utils.PropertyFileReader;


public class OWLServiceImpl implements OWLService{
	
	@Autowired
	UserService userService;
	
	@Autowired
	DBService dbService;
	
	// default configuration file
<span class="fc" id="L71">	private static String configFile = &quot;config.properties&quot;;</span>
<span class="fc" id="L72">	private static Logger logger = LogManager</span>
<span class="fc" id="L73">			.getLogger(OWLServiceImpl.class.getName());</span>
	
	
	private OWLOntology baseOntology;
<span class="fc" id="L77">	BlockingQueue&lt;OWLReasoner&gt; reasoners = new LinkedBlockingDeque&lt;&gt;();</span>

	
	private OWLOntologyManager manager;
	private DefaultPrefixManager prefix;
	private Map&lt;String, OWLReasoner&gt; userReasoners;
	Properties prop;
	
<span class="fc" id="L85">	public OWLServiceImpl() throws IOException, OWLOntologyCreationException {</span>
<span class="fc" id="L86">		prop = PropertyFileReader.loadProperties(configFile);</span>
<span class="fc" id="L87">		manager = OWLManager.createOWLOntologyManager();</span>
<span class="fc" id="L88">		this.userReasoners = new HashMap&lt;String,OWLReasoner&gt;();</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">		if(this.baseOntology != null) </span>
<span class="nc" id="L90">			manager.removeOntology(baseOntology);</span>
		
		//this.baseOntology = loadFromWeb(prop.getProperty(&quot;ontologyBaseEndPoint&quot;));
<span class="fc" id="L93">		this.baseOntology = loadFromFile(prop.getProperty(&quot;ontologySifisEndPoint&quot;));</span>
		
<span class="fc" id="L95">		int n = Integer.valueOf(prop.getProperty(&quot;queueSize&quot;));</span>
		
<span class="fc bfc" id="L97" title="All 2 branches covered.">		for(int i = 0; i &lt; n; i++){</span>
<span class="pc" id="L98">			try {reasoners.put(initHermiTReasoner(this.baseOntology));} catch (InterruptedException e) {e.printStackTrace();}</span>
		}
		
		//this.reasoner = initHermiTReasoner(this.baseOntology);
<span class="fc" id="L102">		this.prefix = new DefaultPrefixManager(null, null,baseOntology.getOntologyID().getOntologyIRI().get().toString() + &quot;#&quot;);</span>
<span class="fc" id="L103">	    this.prefix.setPrefix(&quot;eupont:&quot;, &quot;http://elite.polito.it/ontologies/eupont.owl#&quot;);</span>
	    //this.prefix.setPrefix(&quot;eupont-conversational&quot;, &quot;http://elite.polito.it/ontologies/eupont-conversational.owl&quot;);
<span class="fc" id="L105">	    this.prefix.setPrefix(&quot;foaf:&quot;, &quot;http://xmlns.com/foaf/0.1/&quot;);</span>
<span class="fc" id="L106">	    System.out.println(baseOntology.getOntologyID().getOntologyIRI().get());</span>
<span class="fc" id="L107">	}</span>
	
	
	/**
	 * This method loads an ontology from the web
	 * 
	 * 
	 * @param ontologyUrl URL of the base ontology
	 * @return OWLOntology
	 * @throws OWLOntologyCreationException
	 */
	public OWLOntology loadFromWeb(String ontologyUrl) throws OWLOntologyCreationException{
<span class="nc" id="L119">		logger.info(&quot;Load ontology from the web at: &quot; + ontologyUrl);</span>
<span class="nc" id="L120">		IRI ontologyIri = IRI.create(ontologyUrl);</span>
<span class="nc" id="L121">		OWLOntology ontology =  manager.loadOntologyFromOntologyDocument(ontologyIri);</span>
<span class="nc" id="L122">		logger.info(&quot;Ontology succesfully loaded&quot;);</span>
<span class="nc" id="L123">		return ontology;</span>
	}

	/**
	 * This method loads an ontology from a local file
	 * 
	 * @param ontologyUrl URL of the base ontology
	 * @return OWLOntology
	 * @throws OWLOntologyCreationException
	 */
	public OWLOntology loadFromFile(String ontologyUrl) throws OWLOntologyCreationException {
<span class="fc" id="L134">		logger.info(&quot;Load ontology from file: &quot; + ontologyUrl);</span>

<span class="fc" id="L136">		ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span>
<span class="fc" id="L137">		InputStream ontologyF = classloader.getResourceAsStream(prop.getProperty(&quot;ontologyDir&quot;) + ontologyUrl);		</span>

<span class="fc" id="L139">		File ontologyDir = new File(classloader.getResource(prop.getProperty(&quot;ontologyDir&quot;)).getFile());</span>
<span class="fc" id="L140">		manager.getIRIMappers().add(new AutoIRIMapper(ontologyDir, true));</span>
		
<span class="fc" id="L142">		OWLOntology ontology =  manager.loadOntologyFromOntologyDocument(ontologyF);</span>
<span class="fc" id="L143">		return ontology;</span>
	}
	
	
	
	/**
	 * This method returns an instance of the base ontology
	 *  
	 * @return OWLOntology
	 */
	public OWLOntology getBaseOntology(){
<span class="nc" id="L154">		return this.baseOntology;</span>
	}

	/**
	 * This methods creates a HermiT reasoner for a loaded ontology
	 */
	public OWLReasoner initHermiTReasoner(OWLOntology ontology) {
<span class="fc" id="L161">		logger.info(&quot;Create reasoner&quot;);</span>
<span class="fc" id="L162">		OWLReasoner reasoner = new Reasoner.ReasonerFactory().createNonBufferingReasoner(ontology);</span>
<span class="fc" id="L163">		reasoner.precomputeInferences(InferenceType.values());</span>
<span class="fc" id="L164">		logger.info(&quot;Reasoner succesfully created&quot;);</span>
<span class="fc" id="L165">		return reasoner;</span>
	}

	/**
	 * This method duplicate the base ontology for a new user
	 * 
	 * @param fileName the name for the new ontology
	 * @throws OWLOntologyStorageException
	 * @throws FileNotFoundException
	 * @throws OWLOntologyCreationException 
	 */
	public void addOntology(String fileName, IRI iri) throws OWLOntologyStorageException, FileNotFoundException, OWLOntologyCreationException{
		
<span class="fc" id="L178">		logger.info(&quot;Add a new ontology with file name: &quot; + fileName);</span>
		
<span class="fc" id="L180">		ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span>

		//Creation of the new ontology with a custom user-URI
<span class="fc" id="L183">		OWLOntology newOntology = this.manager.createOntology(iri);</span>
<span class="fc" id="L184">		this.prefix.setPrefix(fileName + &quot;:&quot;, iri + &quot;#&quot;);</span>
		//Add the import of the base ontology (i.e., EUPont-composition)
<span class="fc" id="L186">		OWLImportsDeclaration importDeclaration = this.manager.getOWLDataFactory().getOWLImportsDeclaration(this.baseOntology.getOntologyID().getOntologyIRI().get());</span>
<span class="fc" id="L187">		this.manager.applyChange(new AddImport(newOntology,importDeclaration));</span>
		
<span class="fc" id="L189">		OWLNamedIndividual user = newOntology.getOWLOntologyManager().getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getPrefix(fileName + &quot;:&quot;) + fileName));</span>
<span class="fc" id="L190">		OWLClass userClass = newOntology.getOWLOntologyManager().getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;foaf:&quot;) + &quot;Person&quot;));</span>
<span class="fc" id="L191">		OWLClassAssertionAxiom userAxiom = newOntology.getOWLOntologyManager().getOWLDataFactory().getOWLClassAssertionAxiom(userClass, user);</span>
<span class="fc" id="L192">		this.manager.applyChange(new AddAxiom(newOntology, userAxiom));</span>
				
		//Save the new ontology
		
<span class="fc" id="L196">		File ontologyDir = new File(classloader.getResource(prop.getProperty(&quot;ontologyDir&quot;)).getFile());</span>
		
<span class="fc" id="L198">		File file = new File(ontologyDir.getAbsolutePath() + fileName + &quot;.owl&quot;);</span>
<span class="fc" id="L199">		BufferedOutputStream outputStream = new BufferedOutputStream(new FileOutputStream(file));	</span>
<span class="fc" id="L200">		manager.saveOntology(newOntology, outputStream);</span>

<span class="fc" id="L202">		OWLReasoner userReasoner = this.initHermiTReasoner(newOntology);</span>
<span class="fc" id="L203">		this.userReasoners.put(fileName, userReasoner);</span>
<span class="fc" id="L204">		logger.info(&quot;Ontology succesfully added&quot;);</span>
<span class="fc" id="L205">	}</span>

	/**
	 * This method returns the IRI of the base ontology
	 */
	@Override
	public IRI getBaseIRI() {
<span class="fc" id="L212">		return baseOntology.getOntologyID().getOntologyIRI().get();</span>
	}
	

	
	
	
	@Override
	public Set&lt;Service&gt; getTriggerServices() throws InterruptedException {
		
<span class="fc" id="L222">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="fc" id="L223">		Set&lt;Service&gt; services = new HashSet&lt;Service&gt;();</span>

		try{
			
<span class="fc" id="L227">			OWLClass serviceClass = this.manager.getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;Channel&quot;));</span>
<span class="fc" id="L228">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L229">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L230">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L231">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
<span class="fc" id="L232">			OWLObjectProperty offerTrigger = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerTrigger&quot;));</span>
<span class="fc" id="L233">			Set&lt;OWLClass&gt; owlServiceClasses = reasoner.getSubClasses(serviceClass, true).getFlattened();</span>
			
<span class="fc bfc" id="L235" title="All 2 branches covered.">			for(OWLClass owlServiceClass : owlServiceClasses){</span>
<span class="fc" id="L236">				Set&lt;OWLNamedIndividual&gt; owlServices = reasoner.getInstances(owlServiceClass, true).getFlattened();</span>
<span class="fc" id="L237">				boolean add = false;</span>
<span class="fc" id="L238">				Set&lt;Service&gt; tempServices = new HashSet&lt;Service&gt;();</span>
	
<span class="fc bfc" id="L240" title="All 2 branches covered.">				for(OWLNamedIndividual owlService : owlServices){</span>
					
<span class="fc bfc" id="L242" title="All 2 branches covered.">					if(reasoner.getObjectPropertyValues(owlService, offerTrigger).getFlattened().size() &gt; 0)</span>
<span class="fc" id="L243">						add = true;</span>
					
<span class="fc" id="L245">					Service service = new Service();</span>
<span class="fc" id="L246">					service.setURL(owlService.getIRI().toString());</span>
<span class="fc" id="L247">					service.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
					
<span class="pc" id="L249">					try{service.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral() + &quot; Triggers&quot;);}catch(Throwable t){}</span>
<span class="pc" id="L250">					try{service.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="pc" id="L251">					try{service.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L252">					try{service.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
	
<span class="fc" id="L254">					tempServices.add(service);</span>
<span class="fc" id="L255">				}</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">				if(add)</span>
<span class="fc" id="L257">					services.addAll(tempServices);</span>
<span class="fc" id="L258">			}</span>
		
		}finally{
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L263">		return services;</span>
	}
	
	@Override
	public Trigger getTrigger(String url, String username) throws OWLOntologyCreationException, InterruptedException {
<span class="fc" id="L268">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="fc" id="L269">		Trigger trigger = new Trigger();</span>
		try{
<span class="fc" id="L271">			OWLObjectProperty isOfChannel = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;isOfChannel&quot;));</span>
<span class="fc" id="L272">			OWLDataProperty description = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;description&quot;));</span>
<span class="fc" id="L273">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L274">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L275">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L276">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
			
			
<span class="fc" id="L279">			OWLNamedIndividual owlTrigger = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(url));</span>
<span class="fc" id="L280">			trigger.setURL(owlTrigger.getIRI().toString());</span>
<span class="fc" id="L281">			trigger.setId(this.prefix.getShortForm(owlTrigger.getIRI()).substring(1));</span>
<span class="pc" id="L282">			try{trigger.setName(reasoner.getDataPropertyValues(owlTrigger,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L283">			try{trigger.setDescription(reasoner.getDataPropertyValues(owlTrigger,description).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L284">			Set&lt;OWLNamedIndividual&gt; channels = reasoner.getObjectPropertyValues(owlTrigger, isOfChannel).getFlattened();</span>
<span class="fc" id="L285">			OWLNamedIndividual owlService = channels.iterator().next();</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">			if(owlService != null){</span>
<span class="fc" id="L287">				Service service = new Service();</span>
<span class="fc" id="L288">				service.setURL(owlService.getIRI().toString());</span>
<span class="fc" id="L289">				service.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
<span class="pc" id="L290">				try{service.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L291">				try{service.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="pc" id="L292">				try{service.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L293">				try{service.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L294">				trigger.setService(service);</span>
<span class="fc" id="L295">				trigger.setDetails(this.getTriggerDetails(reasoner, service.getId(), trigger.getId(), username));</span>
			}
		}
		finally{
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">			if(reasoner != null)  this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L301">		return trigger;</span>
	}

	
	@Override
	public Set&lt;Trigger&gt; getTriggers(String service, String username) throws InterruptedException, OWLOntologyCreationException {
<span class="fc" id="L307">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="fc" id="L308">		Set&lt;Trigger&gt; triggers = new HashSet&lt;Trigger&gt;();</span>
		try{
<span class="fc" id="L310">			OWLDataProperty description = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;description&quot;));</span>
<span class="fc" id="L311">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L312">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L313">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L314">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
<span class="fc" id="L315">			OWLNamedIndividual owlService = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + service));</span>
<span class="fc" id="L316">			Service s = new Service();</span>
<span class="fc" id="L317">			s.setURL(owlService.getIRI().toString());</span>
<span class="fc" id="L318">			s.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
<span class="pc" id="L319">			try{s.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L320">			try{s.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="pc" id="L321">			try{s.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L322">			try{s.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
			
			
<span class="fc" id="L325">			OWLObjectProperty offerTrigger = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerTrigger&quot;));</span>
			
			Set&lt;OWLNamedIndividual&gt; owlTriggers;
		
<span class="pc bpc" id="L329" title="2 of 4 branches missed.">			if(reasoner != null &amp;&amp; reasoner.getObjectPropertyValues(owlService, offerTrigger) != null){</span>
<span class="fc" id="L330">				owlTriggers = reasoner.getObjectPropertyValues(owlService, offerTrigger).getFlattened();</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">				for(OWLNamedIndividual owlTrigger : owlTriggers){</span>
<span class="fc" id="L332">					Trigger trigger = new Trigger();</span>
<span class="fc" id="L333">					trigger.setURL(owlTrigger.getIRI().toString());</span>
<span class="fc" id="L334">					trigger.setId(this.prefix.getShortForm(owlTrigger.getIRI()).substring(1));</span>
<span class="fc" id="L335">					trigger.setService(s);</span>
<span class="pc" id="L336">					try{trigger.setName(reasoner.getDataPropertyValues(owlTrigger,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L337">					try{trigger.setDescription(reasoner.getDataPropertyValues(owlTrigger,description).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L338">					triggers.add(trigger);</span>
<span class="fc" id="L339">					trigger.setDetails(this.getTriggerDetails(reasoner, s.getId(), trigger.getId(), username));</span>

<span class="fc" id="L341">				}</span>
			}
		}
		finally{
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L347">		return triggers;</span>
	}



	@Override
	public List&lt;Detail&gt; getTriggerDetails(OWLReasoner reasoner, String service, String trigger, String username) throws OWLOntologyCreationException, InterruptedException {
<span class="fc" id="L354">		List&lt;Detail&gt; details = new LinkedList&lt;Detail&gt;();</span>
<span class="fc" id="L355">		boolean taken = false;</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">		if(reasoner == null){</span>
<span class="fc" id="L357">			taken = true;</span>
<span class="fc" id="L358">			reasoner = this.reasoners.take();</span>
		}
		
<span class="fc" id="L361">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="fc bfc" id="L363" title="All 2 branches covered.">		if(userReasoner == null){</span>
<span class="fc" id="L364">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="fc" id="L365">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">			if(userOntology == null)</span>
<span class="fc" id="L367">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="fc" id="L368">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="fc" id="L369">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="fc" id="L370">			this.userReasoners.put(username, userReasoner);</span>
		}
		
		try{
<span class="fc" id="L374">			OWLClass owlLocationClass = this.manager.getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;Location&quot;));</span>

<span class="fc" id="L376">			OWLNamedIndividual owlTrigger = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + trigger));</span>
<span class="fc" id="L377">			OWLObjectProperty offerDetail = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerDetail&quot;));</span>
<span class="fc" id="L378">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L379">			OWLDataProperty type = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;type&quot;));</span>
<span class="fc" id="L380">			OWLDataProperty type2 = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;type&quot;));</span>

<span class="fc" id="L382">			Set&lt;OWLNamedIndividual&gt; owlDetails = reasoner.getObjectPropertyValues(owlTrigger, offerDetail).getFlattened();</span>
			
			
<span class="fc" id="L385">			Set&lt;Object&gt; entities = new HashSet&lt;Object&gt;();</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">			for(IoTEntity entity : this.getIoTEntitiesByService(service, username)){</span>
<span class="nc" id="L387">				entities.add(entity);</span>
<span class="nc" id="L388">			}</span>
			
			
<span class="fc" id="L391">			boolean entityDetail = false;</span>
			
<span class="fc bfc" id="L393" title="All 2 branches covered.">			for(OWLNamedIndividual owlDetail : owlDetails){</span>
<span class="fc" id="L394">				Detail detail = new Detail();</span>
<span class="fc" id="L395">				detail.setId(this.prefix.getShortForm(owlDetail.getIRI()).substring(1));</span>
<span class="fc" id="L396">				detail.setURL(owlDetail.getIRI().toString());</span>
<span class="pc" id="L397">				try{detail.setName(reasoner.getDataPropertyValues(owlDetail,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L398">				String detailType = null;</span>
<span class="pc" id="L399">				try{detailType = reasoner.getDataPropertyValues(owlDetail,type).iterator().next().getLiteral();}catch(Throwable t){}</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">				if(detailType == null)</span>
<span class="nc" id="L401">					try{detailType = reasoner.getDataPropertyValues(owlDetail,type2).iterator().next().getLiteral();}catch(Throwable t){}</span>

<span class="fc" id="L403">				detail.setType(detailType);</span>
				
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">				if(detailType.equals(&quot;entity&quot;)){</span>
<span class="nc" id="L406">					entityDetail = true;</span>
<span class="nc" id="L407">					detail.setAlternatives(entities);</span>
				}
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">				if(detailType.equals(&quot;location&quot;)){</span>
<span class="nc" id="L410">					Set&lt;Object&gt; locations = new HashSet&lt;Object&gt;();</span>
					
<span class="nc" id="L412">					Set&lt;OWLNamedIndividual&gt; owlLocations = userReasoner.getInstances(owlLocationClass, false).getFlattened();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">					for (OWLNamedIndividual owlLocation : owlLocations) {</span>
<span class="nc" id="L414">						Location loc = new Location();</span>
<span class="nc" id="L415">						loc.setURL(owlLocation.getIRI().toString());</span>
<span class="nc" id="L416">						try{loc.setName(userReasoner.getDataPropertyValues(owlLocation,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L417">						locations.add(loc);</span>
<span class="nc" id="L418">					}</span>
					

<span class="nc" id="L421">					detail.setAlternatives(locations);</span>
				}
<span class="fc" id="L423">				details.add(detail);</span>
<span class="fc" id="L424">			}</span>
			
<span class="pc bpc" id="L426" title="2 of 4 branches missed.">			if(!entityDetail &amp;&amp; entities.size() &gt; 0){</span>
<span class="nc" id="L427">				Detail detail = new Detail();</span>
<span class="nc" id="L428">				detail.setName(&quot;Which entity?&quot;);</span>
<span class="nc" id="L429">				detail.setType(&quot;entity&quot;);</span>
<span class="nc" id="L430">				detail.setURL(&quot;entity_detail&quot;);</span>
<span class="nc" id="L431">				detail.setAlternatives(entities);</span>
<span class="nc" id="L432">				details.add(detail);</span>
			}
		}
		finally{
<span class="pc bpc" id="L436" title="1 of 4 branches missed.">			if(taken &amp;&amp; reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L438">		return details;</span>
	}

	
	@Override
	public Set&lt;Service&gt; getActionServices() throws InterruptedException {
<span class="fc" id="L444">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="fc" id="L445">		Set&lt;Service&gt; services = new HashSet&lt;Service&gt;();</span>
		try{
<span class="fc" id="L447">			OWLClass serviceClass = this.manager.getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;Channel&quot;));</span>
<span class="fc" id="L448">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L449">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L450">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L451">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
<span class="fc" id="L452">			OWLObjectProperty offerAction = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerAction&quot;));</span>
			
<span class="fc" id="L454">			Set&lt;OWLClass&gt; owlServiceClasses = reasoner.getSubClasses(serviceClass, true).getFlattened();</span>
			
<span class="fc bfc" id="L456" title="All 2 branches covered.">			for(OWLClass owlServiceClass : owlServiceClasses){</span>
<span class="fc" id="L457">				Set&lt;OWLNamedIndividual&gt; owlServices = reasoner.getInstances(owlServiceClass, true).getFlattened();</span>
<span class="fc" id="L458">				boolean add = false;</span>
<span class="fc" id="L459">				Set&lt;Service&gt; tempServices = new HashSet&lt;Service&gt;();</span>
	
<span class="fc bfc" id="L461" title="All 2 branches covered.">				for(OWLNamedIndividual owlService : owlServices){</span>
					
<span class="fc" id="L463">					Set&lt;OWLObjectProperty&gt; x = this.baseOntology.getObjectPropertiesInSignature();</span>

<span class="fc bfc" id="L465" title="All 2 branches covered.">					if(reasoner.getObjectPropertyValues(owlService, offerAction).getFlattened().size() &gt; 0)</span>
<span class="fc" id="L466">						add = true;</span>
					
<span class="fc" id="L468">					Service service = new Service();</span>
<span class="fc" id="L469">					service.setURL(owlService.getIRI().toString());</span>
<span class="fc" id="L470">					service.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
					
<span class="pc" id="L472">					try{service.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral() + &quot; Actions&quot;);}catch(Throwable t){}</span>
<span class="pc" id="L473">					try{service.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="pc" id="L474">					try{service.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L475">					try{service.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
	
<span class="fc" id="L477">					tempServices.add(service);</span>
<span class="fc" id="L478">				}</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">				if(add)</span>
<span class="fc" id="L480">					services.addAll(tempServices);</span>
<span class="fc" id="L481">		}</span>
		}finally{
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">			if(reasoner != null)  this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L485">		return services;</span>
	}
	
	@Override
	public Action getAction(String url, String username) throws OWLOntologyCreationException, InterruptedException {
<span class="fc" id="L490">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="fc" id="L491">		Action action = new Action();</span>
		try{
<span class="fc" id="L493">			OWLObjectProperty isOfChannel = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;isOfChannel&quot;));</span>
<span class="fc" id="L494">			OWLDataProperty description = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;description&quot;));</span>
<span class="fc" id="L495">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L496">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L497">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L498">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
			
			
<span class="fc" id="L501">			OWLNamedIndividual owlAction = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(url));</span>
<span class="fc" id="L502">			action.setURL(owlAction.getIRI().toString());</span>
<span class="fc" id="L503">			action.setId(this.prefix.getShortForm(owlAction.getIRI()).substring(1));</span>
<span class="pc" id="L504">			try{action.setName(reasoner.getDataPropertyValues(owlAction,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L505">			try{action.setDescription(reasoner.getDataPropertyValues(owlAction,description).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L506">			Set&lt;OWLNamedIndividual&gt; channels = reasoner.getObjectPropertyValues(owlAction, isOfChannel).getFlattened();</span>
<span class="fc" id="L507">			OWLNamedIndividual owlService = channels.iterator().next();</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">			if(owlService != null){</span>
<span class="fc" id="L509">				Service service = new Service();</span>
<span class="fc" id="L510">				service.setURL(owlService.getIRI().toString());</span>
<span class="fc" id="L511">				service.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
<span class="pc" id="L512">				try{service.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L513">				try{service.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="pc" id="L514">				try{service.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L515">				try{service.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L516">				action.setService(service);</span>
<span class="fc" id="L517">				action.setDetails(this.getActionDetails(reasoner, service.getId(), action.getId(), username));</span>
		}
		} finally {
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">			if(reasoner != null)  this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L522">		return action;</span>
	}
	
	
	@Override
	public Set&lt;Action&gt; getActions(String service, String username) throws InterruptedException, OWLOntologyCreationException {
<span class="nc" id="L528">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="nc" id="L529">		Set&lt;Action&gt; actions = new HashSet&lt;Action&gt;();</span>
		try{
<span class="nc" id="L531">			OWLDataProperty description = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;description&quot;));</span>
<span class="nc" id="L532">			OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="nc" id="L533">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="nc" id="L534">			OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="nc" id="L535">			OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
			
<span class="nc" id="L537">			OWLNamedIndividual owlService = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + service));</span>
			
<span class="nc" id="L539">			OWLObjectProperty offerAction = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerAction&quot;));</span>
			Set&lt;OWLNamedIndividual&gt; owlActions;
			
<span class="nc bnc" id="L542" title="All 4 branches missed.">			if(reasoner != null &amp;&amp; reasoner.getObjectPropertyValues(owlService, offerAction) != null){</span>
<span class="nc" id="L543">				owlActions = reasoner.getObjectPropertyValues(owlService, offerAction).getFlattened();</span>
			
			
<span class="nc" id="L546">				Service s = new Service();</span>
<span class="nc" id="L547">				s.setURL(owlService.getIRI().toString());</span>
<span class="nc" id="L548">				s.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
<span class="nc" id="L549">				try{s.setName(reasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L550">				try{s.setWebId(Long.valueOf(reasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="nc" id="L551">				try{s.setColor(reasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L552">				try{s.setImage(reasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
				
<span class="nc bnc" id="L554" title="All 2 branches missed.">				for(OWLNamedIndividual owlAction : owlActions){</span>
<span class="nc" id="L555">					Action action = new Action();</span>
<span class="nc" id="L556">					action.setURL(owlAction.getIRI().toString());</span>
<span class="nc" id="L557">					action.setId(this.prefix.getShortForm(owlAction.getIRI()).substring(1));</span>
<span class="nc" id="L558">					action.setService(s);</span>
<span class="nc" id="L559">					try{action.setName(reasoner.getDataPropertyValues(owlAction,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L560">					try{action.setDescription(reasoner.getDataPropertyValues(owlAction,description).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L561">					actions.add(action);</span>
<span class="nc" id="L562">					action.setDetails(this.getActionDetails(reasoner, s.getId(), action.getId(), username));</span>
<span class="nc" id="L563">				}</span>
			}
		}
		finally{
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="nc" id="L569">		return actions;</span>
	}
	
	@Override
	public List&lt;Detail&gt; getActionDetails(OWLReasoner reasoner, String service, String action, String username) throws OWLOntologyCreationException, InterruptedException {

<span class="fc" id="L575">		List&lt;Detail&gt; details = new LinkedList&lt;Detail&gt;();</span>
<span class="fc" id="L576">		boolean taken = false;</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">		if(reasoner == null){</span>
<span class="fc" id="L578">			taken = true;</span>
<span class="fc" id="L579">			reasoner = this.reasoners.take();</span>
		}
		
<span class="fc" id="L582">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L585">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L586">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L588">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L589">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="nc" id="L590">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="nc" id="L591">			this.userReasoners.put(username, userReasoner);</span>
		}
		
		try{
<span class="fc" id="L595">			OWLClass owlLocationClass = this.manager.getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;Location&quot;));</span>

<span class="fc" id="L597">			OWLNamedIndividual owlAction = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + action));</span>
<span class="fc" id="L598">			OWLObjectProperty offerDetail = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;offerDetail&quot;));</span>
<span class="fc" id="L599">			OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L600">			OWLDataProperty type = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;type&quot;));</span>
<span class="fc" id="L601">			OWLDataProperty type2 = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;type&quot;));</span>

<span class="fc" id="L603">			Set&lt;OWLNamedIndividual&gt; owlDetails = reasoner.getObjectPropertyValues(owlAction, offerDetail).getFlattened();</span>
			
<span class="fc" id="L605">			Set&lt;Object&gt; entities = new HashSet&lt;Object&gt;();</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">			for(IoTEntity entity : this.getIoTEntitiesByService(service, username)){</span>
<span class="nc" id="L607">				entities.add(entity);</span>
<span class="nc" id="L608">			}</span>
			
<span class="fc" id="L610">			boolean entityDetail = false;</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">			for(OWLNamedIndividual owlDetail : owlDetails){</span>
<span class="fc" id="L612">				Detail detail = new Detail();</span>
<span class="fc" id="L613">				detail.setId(this.prefix.getShortForm(owlDetail.getIRI()).substring(1));</span>
<span class="fc" id="L614">				detail.setURL(owlDetail.getIRI().toString());</span>
<span class="pc" id="L615">				try{detail.setName(reasoner.getDataPropertyValues(owlDetail,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L616">				String detailType = null;</span>
<span class="pc" id="L617">				try{detailType = reasoner.getDataPropertyValues(owlDetail,type).iterator().next().getLiteral();}catch(Throwable t){}</span>
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">				if(detailType == null)</span>
<span class="nc" id="L619">					try{detailType = reasoner.getDataPropertyValues(owlDetail,type2).iterator().next().getLiteral();}catch(Throwable t){}</span>

				
<span class="fc" id="L622">				detail.setType(detailType);</span>
				
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">				if(detailType.equals(&quot;entity&quot;)){</span>
<span class="nc" id="L625">					entityDetail = true;</span>
<span class="nc" id="L626">					detail.setAlternatives(entities);</span>
				}
<span class="fc bfc" id="L628" title="All 2 branches covered.">				if(detailType.equals(&quot;location&quot;)){</span>
<span class="fc" id="L629">					Set&lt;Object&gt; locations = new HashSet&lt;Object&gt;();</span>
					
<span class="fc" id="L631">					Set&lt;OWLNamedIndividual&gt; owlLocations = userReasoner.getInstances(owlLocationClass, false).getFlattened();</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">					for (OWLNamedIndividual owlLocation : owlLocations) {</span>
<span class="fc" id="L633">						Location loc = new Location();</span>
<span class="fc" id="L634">						loc.setURL(owlLocation.getIRI().toString());</span>
<span class="pc" id="L635">						try{loc.setName(userReasoner.getDataPropertyValues(owlLocation,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="fc" id="L636">						locations.add(loc);</span>
<span class="fc" id="L637">					}</span>
					

<span class="fc" id="L640">					detail.setAlternatives(locations);</span>
				}
<span class="fc" id="L642">				details.add(detail);</span>
<span class="fc" id="L643">			}</span>
			
<span class="pc bpc" id="L645" title="2 of 4 branches missed.">			if(!entityDetail &amp;&amp; entities.size() &gt; 0){</span>
<span class="nc" id="L646">				Detail detail = new Detail();</span>
<span class="nc" id="L647">				detail.setName(&quot;Which entity?&quot;);</span>
<span class="nc" id="L648">				detail.setType(&quot;entity&quot;);</span>
<span class="nc" id="L649">				detail.setURL(&quot;entity_detail&quot;);</span>
<span class="nc" id="L650">				detail.setAlternatives(entities);</span>
<span class="nc" id="L651">				details.add(detail);</span>
			}
		}
		finally{
<span class="pc bpc" id="L655" title="1 of 4 branches missed.">			if(taken &amp;&amp; reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="fc" id="L657">		return details;</span>
	}
	
	@Override
	public IoTEntity getIoTEntityByUrl(String url, String username) throws OWLOntologyCreationException {
<span class="fc" id="L662">		OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L663">		OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>

<span class="fc" id="L665">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L668">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L669">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L671">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L672">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="nc" id="L673">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="nc" id="L674">			this.userReasoners.put(username, userReasoner);</span>
		}
		
<span class="fc" id="L677">		OWLNamedIndividual owlEntity = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(url));</span>
<span class="fc" id="L678">		IoTEntity e = new IoTEntity();</span>
<span class="pc" id="L679">		try{e.setName(userReasoner.getDataPropertyValues(owlEntity,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L680">		try{e.setId(userReasoner.getDataPropertyValues(owlEntity,id).iterator().next().getLiteral());}catch(Throwable t){}</span>

<span class="fc" id="L682">		e.setURL(owlEntity.getIRI().toString());				</span>
<span class="fc" id="L683">		List&lt;Service&gt; services = this.getServicesByIoTEntity(e.getURL(),username);</span>
<span class="fc" id="L684">		Set&lt;String&gt; servicesURLS = new HashSet&lt;String&gt;();</span>
<span class="pc bpc" id="L685" title="1 of 2 branches missed.">		for(Service service : services)</span>
<span class="nc" id="L686">			servicesURLS.add(this.prefix.getShortForm(IRI.create(service.getURL())).substring(1));</span>
<span class="fc" id="L687">		e.setServices(servicesURLS);</span>
		try{
<span class="fc" id="L689">			e.setType(this.prefix.getShortForm(userReasoner.getTypes(owlEntity, true).getFlattened().iterator().next()).replace(&quot;eupont:&quot;, &quot;&quot;).toLowerCase());</span>
<span class="pc" id="L690">		}catch(Throwable t) {}</span>
		
	
<span class="fc" id="L693">		return e;</span>
	}
	

	@Override
	public Set&lt;Command&gt; getCommands(Action action, Location location, String username) throws InterruptedException, OWLOntologyCreationException {
<span class="fc" id="L699">		Set&lt;Command&gt; commands = new HashSet&lt;Command&gt;();</span>
<span class="fc" id="L700">		OWLObjectProperty reproduceBy = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;reproduceBy&quot;));</span>
<span class="fc" id="L701">		OWLObjectProperty commandIsOfService = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;commandIsOfService&quot;));</span>
<span class="fc" id="L702">		OWLObjectProperty isOfEntity = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;isOfEntity&quot;));</span>
<span class="fc" id="L703">		OWLObjectProperty position = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;position&quot;));</span>

<span class="fc" id="L705">		OWLNamedIndividual owlAction = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(action.getURL()));</span>

<span class="fc" id="L707">		OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L708">		OWLDataProperty type = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;type&quot;));</span>
<span class="fc" id="L709">		OWLDataProperty type2 = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;type&quot;));</span>

<span class="fc" id="L711">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="pc bpc" id="L713" title="1 of 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L714">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L715">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L717">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L718">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
			
<span class="nc" id="L720">			userReasoner = this.initHermiTReasoner(userOntology);</span>
			
<span class="nc" id="L722">			this.userReasoners.put(username, userReasoner);</span>
		}
		
<span class="fc" id="L725">		userReasoner.precomputeInferences(InferenceType.values());</span>
		
<span class="fc" id="L727">		Set&lt;OWLNamedIndividual&gt; owlCommands = userReasoner.getObjectPropertyValues(owlAction, reproduceBy).getFlattened();</span>
		
<span class="fc bfc" id="L729" title="All 2 branches covered.">		for (OWLNamedIndividual owlCommand : owlCommands) {</span>
			
			//getIoTEntity
<span class="fc" id="L732">			OWLNamedIndividual owlService = userReasoner.getObjectPropertyValues(owlCommand, commandIsOfService).getFlattened().iterator().next();</span>
<span class="fc" id="L733">			OWLNamedIndividual owlEntity = userReasoner.getObjectPropertyValues(owlService, isOfEntity).getFlattened().iterator().next();</span>

			//check IoTEntitiy position
<span class="pc bpc" id="L736" title="2 of 4 branches missed.">			if(location != null &amp;&amp; ! location.getName().equals(&quot;Entire Home&quot;)) {</span>
				try{
<span class="fc" id="L738">					OWLNamedIndividual owlLocation = userReasoner.getObjectPropertyValues(owlEntity, position).getFlattened().iterator().next();</span>
<span class="pc bpc" id="L739" title="1 of 4 branches missed.">					if(owlLocation != null &amp;&amp; ! owlLocation.getIRI().toString().equals(location.getURL()))</span>
<span class="fc" id="L740">						continue;</span>
<span class="nc" id="L741">				}catch (Throwable t) {</span>
<span class="nc" id="L742">					System.err.print(t.getStackTrace());</span>
<span class="fc" id="L743">				}</span>
			}
			
<span class="fc" id="L746">			Command command = new Command();</span>
<span class="fc" id="L747">			command.setURL(this.prefix.getShortForm(owlCommand.getIRI()).substring(1));</span>
<span class="pc" id="L748">			try{command.setId(userReasoner.getDataPropertyValues(owlCommand,id).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc" id="L749">			try{command.setType(userReasoner.getDataPropertyValues(owlCommand,type).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="pc bpc" id="L750" title="1 of 2 branches missed.">			if(command.getType() == null) {</span>
<span class="pc" id="L751">				try{command.setType(userReasoner.getDataPropertyValues(owlCommand,type2).iterator().next().getLiteral());}catch(Throwable t){}</span>
			}
			
<span class="fc" id="L754">			command.setEntitiy(this.getIoTEntityByUrl(owlEntity.getIRI().toString(), username));</span>
			
<span class="fc" id="L756">			commands.add(command);</span>
<span class="fc" id="L757">		}</span>
		
		
<span class="fc" id="L760">		return commands;</span>
	}


	
	
	@Override
	public List&lt;Service&gt; getServicesByIoTEntity(String url, String username) throws OWLOntologyCreationException {
<span class="fc" id="L768">		List&lt;Service&gt; services = new LinkedList&lt;Service&gt;();</span>
<span class="fc" id="L769">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="pc bpc" id="L771" title="1 of 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L772">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L773">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L775">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L776">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="nc" id="L777">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="nc" id="L778">			this.userReasoners.put(username, userReasoner);</span>
		}
		
<span class="fc" id="L781">		OWLObjectProperty hasTechnology = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;hasTechnology&quot;));</span>
<span class="fc" id="L782">		OWLNamedIndividual owlEntity = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(url));</span>

<span class="fc" id="L784">		OWLDataProperty image = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;image&quot;));</span>
<span class="fc" id="L785">		OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>
<span class="fc" id="L786">		OWLDataProperty id = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;id&quot;));</span>
<span class="fc" id="L787">		OWLDataProperty color = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;color&quot;));</span>
		
<span class="fc" id="L789">		Set&lt;OWLNamedIndividual&gt; owlServices = userReasoner.getObjectPropertyValues(owlEntity,hasTechnology).getFlattened();</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">		for(OWLNamedIndividual owlService : owlServices){</span>
<span class="nc" id="L791">			Service service = new Service();</span>
<span class="nc" id="L792">			service.setURL(owlService.getIRI().toString());</span>
<span class="nc" id="L793">			service.setId(prefix.getShortForm(owlService.getIRI()).substring(1));</span>
			
<span class="nc" id="L795">			try{service.setName(userReasoner.getDataPropertyValues(owlService,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L796">			try{service.setWebId(Long.valueOf(userReasoner.getDataPropertyValues(owlService,id).iterator().next().getLiteral()));}catch(Throwable t){}</span>
<span class="nc" id="L797">			try{service.setColor(userReasoner.getDataPropertyValues(owlService,color).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L798">			try{service.setImage(userReasoner.getDataPropertyValues(owlService,image).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L799">			services.add(service);</span>
			
<span class="nc" id="L801">		}</span>
		
<span class="fc" id="L803">		return services;</span>
	}


	@Override
	public Collection&lt;IoTEntity&gt; getIoTEntitiesByService(String service, String username) throws OWLOntologyCreationException {
		
<span class="fc" id="L810">		OWLDataProperty name = this.manager.getOWLDataFactory().getOWLDataProperty(IRI.create(this.prefix.getDefaultPrefix() + &quot;name&quot;));</span>

<span class="fc" id="L812">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
		
<span class="pc bpc" id="L814" title="1 of 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L815">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L816">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L818">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L819">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="nc" id="L820">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="nc" id="L821">			this.userReasoners.put(username, userReasoner);</span>
		}

<span class="fc" id="L824">		Set&lt;IoTEntity&gt; entities = new HashSet&lt;IoTEntity&gt;();</span>
<span class="fc" id="L825">		OWLNamedIndividual owlService = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + service));</span>
<span class="fc" id="L826">		OWLObjectProperty hasRegisteredEntity = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;hasRegisteredEntity&quot;));</span>
<span class="fc" id="L827">		Set&lt;OWLNamedIndividual&gt; owlEntities = userReasoner.getObjectPropertyValues(owlService, hasRegisteredEntity).getFlattened();</span>
<span class="pc bpc" id="L828" title="1 of 2 branches missed.">		for(OWLNamedIndividual owlEntity : owlEntities){</span>
<span class="nc" id="L829">			IoTEntity e = new IoTEntity();</span>
<span class="nc" id="L830">			try{e.setName(userReasoner.getDataPropertyValues(owlEntity,name).iterator().next().getLiteral());}catch(Throwable t){}</span>
<span class="nc" id="L831">			e.setId(this.prefix.getShortForm(owlEntity.getIRI()).substring(1));</span>
<span class="nc" id="L832">			e.setURL(owlEntity.getIRI().toString());</span>
<span class="nc" id="L833">			entities.add(e);</span>
<span class="nc" id="L834">		}</span>

<span class="fc" id="L836">		return entities;</span>
	}
	
	
	
	
	
	
	
	@Override
	public boolean triggers(Action action, Trigger trigger) throws InterruptedException {
<span class="nc" id="L847">		OWLReasoner reasoner = this.reasoners.take();</span>
		try{
<span class="nc" id="L849">			OWLNamedIndividual owlAction = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(action.getURL()));</span>
<span class="nc" id="L850">			OWLObjectProperty owlTriggersProp = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;triggers&quot;));</span>
			
<span class="nc" id="L852">			Set&lt;OWLNamedIndividual&gt; owlTriggers = reasoner.getObjectPropertyValues(owlAction, owlTriggersProp).getFlattened();</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">			for(OWLNamedIndividual owlTrigger : owlTriggers){</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">				if(owlTrigger.getIRI().toString().equals(trigger.getURL()))</span>
<span class="nc" id="L855">					return true;</span>
<span class="nc" id="L856">			}</span>
		}
		finally{
<span class="nc bnc" id="L859" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="nc" id="L861">		return false;</span>
	}
	
	@Override
	public void saveRule(Rule rule) {
		
		
<span class="nc" id="L868">	}</span>
	
	
	


	

	@Override
	public boolean equalsML(Action action1, Action action2) {
<span class="fc" id="L878">		OWLNamedIndividual owlAction1 = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(action1.getURL()));</span>
<span class="fc" id="L879">		OWLNamedIndividual owlAction2 = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(action2.getURL()));</span>

<span class="fc" id="L881">		Collection&lt;OWLClassExpression&gt; action1Types = (Collection&lt;OWLClassExpression&gt;) EntitySearcher.getTypes(owlAction1, this.baseOntology);</span>
<span class="fc" id="L882">		Collection&lt;OWLClassExpression&gt; action2Types = (Collection&lt;OWLClassExpression&gt;) EntitySearcher.getTypes(owlAction2, this.baseOntology);</span>
		
<span class="fc bfc" id="L884" title="All 2 branches covered.">		for(OWLClassExpression c1 : action1Types){</span>
<span class="fc bfc" id="L885" title="All 2 branches covered.">			for(OWLClassExpression c2 : action2Types){</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">				if(c1.equals(c2))</span>
<span class="nc" id="L887">					return true;</span>
<span class="fc" id="L888">			}</span>
<span class="fc" id="L889">		}</span>
<span class="fc" id="L890">		return false;</span>
	}


	@Override
	public Set&lt;OWLClass&gt; getSubClasses(String className) throws InterruptedException {
<span class="nc" id="L896">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="nc" id="L897">		Set&lt;OWLClass&gt; classes = new HashSet&lt;OWLClass&gt;();</span>
		try{
<span class="nc" id="L899">			OWLClass owlClass = this.manager.getOWLDataFactory().getOWLClass(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + className));</span>
<span class="nc" id="L900">			classes.addAll(reasoner.getSubClasses(owlClass, false).getFlattened());</span>
		}
		finally{
<span class="nc bnc" id="L903" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="nc" id="L905">		return classes;		</span>
	}

	@Override
	public List&lt;String&gt; getDirectClasses(String individualURL) throws InterruptedException {
<span class="nc" id="L910">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="nc" id="L911">		List&lt;String&gt; classes = new LinkedList&lt;String&gt;();</span>
		try{
<span class="nc" id="L913">			OWLNamedIndividual owlIndividual = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(individualURL));</span>
<span class="nc" id="L914">			Set&lt;OWLClass&gt; owlClasses = reasoner.getTypes(owlIndividual, true).getFlattened();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">			for(OWLClass owlClass : owlClasses){</span>
<span class="nc" id="L916">				classes.add(owlClass.getIRI().toString());</span>
<span class="nc" id="L917">			}</span>

		}finally{
<span class="nc bnc" id="L920" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="nc" id="L922">		return classes;</span>
	}


	@Override
	public List&lt;String&gt; getClasses(String individualURL) throws InterruptedException {
<span class="nc" id="L928">		OWLReasoner reasoner = this.reasoners.take();</span>
<span class="nc" id="L929">		List&lt;String&gt; classes = new LinkedList&lt;String&gt;();</span>
		try{
<span class="nc" id="L931">			OWLNamedIndividual owlIndividual = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + individualURL.replace(&quot;_&quot;, &quot;&quot;)));</span>
<span class="nc" id="L932">			Set&lt;OWLClass&gt; owlClasses = reasoner.getTypes(owlIndividual, false).getFlattened();</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">			for(OWLClass owlClass : owlClasses){</span>
<span class="nc" id="L934">				classes.add(owlClass.getIRI().toString());</span>
<span class="nc" id="L935">			}</span>

		}finally{
<span class="nc bnc" id="L938" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
<span class="nc" id="L940">		return classes;</span>
	}
	
	public List&lt;String&gt; getClasses(String individualURL, String username) throws OWLOntologyCreationException {
<span class="nc" id="L944">		OWLReasoner userReasoner = this.userReasoners.get(username);</span>
<span class="nc" id="L945">		List&lt;String&gt; classes = new LinkedList&lt;String&gt;();</span>

<span class="nc bnc" id="L947" title="All 2 branches missed.">		if(userReasoner == null){</span>
<span class="nc" id="L948">			IRI userIRI = IRI.create(this.getBaseIRI() + &quot;/&quot; + username);</span>
<span class="nc" id="L949">			OWLOntology userOntology = this.manager.getOntology(userIRI);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">			if(userOntology == null)</span>
<span class="nc" id="L951">				userOntology = this.loadFromFile(username + &quot;.owl&quot;);</span>
<span class="nc" id="L952">			this.prefix.setPrefix(username + &quot;:&quot;, userIRI + &quot;#&quot;);</span>
<span class="nc" id="L953">			userReasoner = this.initHermiTReasoner(userOntology);</span>
<span class="nc" id="L954">			this.userReasoners.put(username, userReasoner);</span>
		}
			
<span class="nc" id="L957">		OWLNamedIndividual owlIndividual = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(individualURL));</span>

<span class="nc" id="L959">		Set&lt;OWLClass&gt; owlClasses = userReasoner.getTypes(owlIndividual, false).getFlattened();</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">		for(OWLClass owlClass : owlClasses){</span>
<span class="nc" id="L961">			classes.add(owlClass.getIRI().toString());</span>
<span class="nc" id="L962">		}</span>
<span class="nc" id="L963">		return classes;</span>
	}


	@Override
	public String getTechnology(String url, int type) throws InterruptedException {
<span class="nc" id="L969">		OWLReasoner reasoner = this.reasoners.take();</span>
		Set&lt;OWLNamedIndividual&gt; results;
		try{
<span class="nc" id="L972">			OWLNamedIndividual ind = this.manager.getOWLDataFactory().getOWLNamedIndividual(IRI.create(this.prefix.getDefaultPrefix() + url.replace(&quot;_&quot;, &quot;&quot;)));</span>
			
			OWLObjectProperty op;
<span class="nc bnc" id="L975" title="All 2 branches missed.">			if(type == 1)</span>
<span class="nc" id="L976">				op = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;isOfChannel&quot;));</span>
			else
<span class="nc" id="L978">				op = this.manager.getOWLDataFactory().getOWLObjectProperty(IRI.create(this.prefix.getPrefix(&quot;eupont:&quot;) + &quot;isOfChannel&quot;));</span>
			
<span class="nc" id="L980">			results = reasoner.getObjectPropertyValues(ind, op).getFlattened();</span>

			
			
		}finally{
<span class="nc bnc" id="L985" title="All 2 branches missed.">			if(reasoner != null) this.reasoners.put(reasoner);</span>
		}
		
<span class="nc bnc" id="L988" title="All 2 branches missed.">		if(results.iterator().hasNext())</span>
<span class="nc" id="L989">			return prefix.getShortForm(results.iterator().next()).substring(1);</span>
		else 
<span class="nc" id="L991">			return null;</span>
	}


	




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>